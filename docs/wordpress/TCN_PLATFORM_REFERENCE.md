# TCN Platform Reference

This reference captures every public capability exposed by the TCN Platform plugin, including REST endpoints, WooCommerce integrations, and the full class/method surface area. Pair it with the built-in **TCN Platform → API Tester** screen to explore endpoints without leaving WordPress.

---

## 1. Using the Admin API Tester

1. Navigate to **TCN Platform → API Tester**.
2. Choose an example card and click **Load in tester** to populate the form with a URL, method, headers, and body tailored to the selected endpoint.
3. If the route requires authentication:
   - For WordPress-authenticated endpoints, open the tester in another tab while logged in as the user and paste the `X-WP-Nonce` generated by `wp_create_nonce( 'wp_rest' )` or use the cookies from an authenticated browser session.
   - For WooCommerce bridges, paste a Base64-encoded `consumer_key:consumer_secret` pair for a key with **Read/Write** permissions.
4. Click **Send Request**. The tester captures the outgoing headers/body and the response status, headers, and body so you can verify behaviour immediately.
5. Use the **View request details** disclosure to copy a cURL-ready JSON payload or tweak headers before retrying.

Every endpoint listed below has a matching preset in the tester, so you can validate authentication, membership upgrades, WooCommerce customer creation, and more without external tools.

---

## 2. REST API Catalogue

### 2.1 Authentication (`/wp-json/gn/v1`)

| Route | Method | Auth | Purpose |
| ----- | ------ | ---- | ------- |
| `/login` | POST | Optional (`mode=cookie` requires credentials; `mode=token` returns one-time token) | Authenticate by username/email + password. Supports cookie login or token hand-off. |
| `/register` | POST | None | Create a WordPress user with profile metadata. Suppresses core notification emails. |
| `/forgot-password` | POST | None | Start a password reset, optionally returning a short-lived verification code. |
| `/reset-password` | POST | None | Complete a reset via verification code or WordPress key. |
| `/change-password` | POST | Logged-in user (cookie or `X-WP-Nonce`) | Change the current user password after verifying the existing password. |

**Key request parameters**

- `login`/`username`/`email`: Accepts username or email, depending on the route.
- `mode`: `cookie` issues auth cookies; omit for token hand-off.
- `return_verification_code`: When truthy, `/forgot-password` returns a one-time code generated by `PasswordLoginService::issue_reset_verification_code()`.
- `key` vs `verification_code`: `/reset-password` accepts either a WP core reset key or the verification code issued by this plugin.

**Common responses**

- Success payloads contain `success: true`, along with contextual data such as `token`, `redirect`, and `user` profile arrays.
- Errors return `WP_Error` objects with HTTP status codes (400, 401, 403, 404, 409, 429) depending on validation failures or rate limiting.

### 2.2 Membership & MLM (`/wp-json/tcn-mlm/v1` and `/wp-json/gn/v1/memberships/*`)

| Route | Method | Auth | Purpose |
| ----- | ------ | ---- | ------- |
| `/tcn-mlm/v1/member` | GET | Logged-in user | Returns the member profile, commission summary, and latest ledger entries. |
| `/tcn-mlm/v1/genealogy` | GET | Logged-in user | Builds a recursive genealogy tree. Optional `depth` query parameter (1–5, default 3). |
| `/tcn-mlm/v1/commissions` | GET | Logged-in user | Returns commission `summary` totals and the `ledger`. |
| `/gn/v1/memberships/plans` | GET | None | Lists membership tiers, WooCommerce product IDs, and Stripe publishable key. |
| `/gn/v1/memberships/stripe-intent` | POST | Logged-in user | Creates a Stripe Payment Intent for a paid upgrade (`plan` body parameter). Requires configured Stripe secret key. |
| `/gn/v1/memberships/confirm` | POST | Logged-in user | Confirms an upgrade, verifies Stripe Payment Intent when required, updates levels, and records commissions. |

**Key request parameters**

- `plan`: Membership slug (`blue`, `gold`, `platinum`, `black`).
- `payment_intent`: Stripe Payment Intent ID (required when the selected plan has a fee).
- `depth`: Optional query parameter to limit genealogy recursion.

**Side effects**

- Successful upgrades call `MembershipModule::set_membership_level()` and `MembershipModule::record_commissions()`.
- WooCommerce orders that contain membership products trigger the same promotion and commission logic through `handle_order_completed()`.

### 2.3 WooCommerce Bridges (`/wp-json/gn/v1/customers`, `/wp-json/gn/v1/orders`)

All endpoints require WooCommerce REST authentication (user capability `manage_woocommerce` or valid consumer key/secret with read/write access).

| Route | Method | Purpose |
| ----- | ------ | ------- |
| `/customers` | GET | Query WooCommerce customers by `email` (query arg). Falls back to WordPress users if no WC customer exists. |
| `/customers` | POST | Create a customer. Accepts `email`, optional `password`, profile fields, plus `billing`/`shipping` arrays. |
| `/orders` | POST | Create an order with `line_items`, optional `customer_id`, `shipping_lines`, `payment_method`, `set_paid`, and `status` overrides. |

**Validation**

- Email parameters pass through `validate_email()` and WordPress helpers.
- Billing/shipping structures must be arrays (`validate_object_type()`).
- Line items require a `product_id` that resolves via `wc_get_product()`.

---

## 3. Class & Function Reference

The tables below enumerate every method, its visibility, parameters, return values, and notable hooks/side effects. Methods marked *static* are invoked without an instance.

### 3.1 `tcnapp-connector.php`

| Function | Visibility | Purpose | Parameters | Returns | Notes |
| -------- | ---------- | ------- | ---------- | ------- | ----- |
| `tcn_platform_boot()` | global | Instantiates `TCN\Platform\Plugin` and boots all services. | — | void | Called immediately after plugin includes and autoload registration. |

### 3.2 `TCN\Platform\Autoloader`

| Method | Visibility | Purpose | Parameters | Returns | Notes |
| ------ | ---------- | ------- | ---------- | ------- | ----- |
| `register()` | static | Registers the plugin’s PSR-4-style autoloader with SPL. | — | void | Call occurs during plugin bootstrap. |
| `autoload( string $class )` | static | Loads classes inside the `TCN\Platform` namespace from the `includes/` directory. | `$class` fully qualified name. | void | Skips classes outside the namespace; requires files on demand. |

### 3.3 `TCN\Platform\Plugin`

| Method | Visibility | Purpose | Parameters | Returns | Notes |
| ------ | ---------- | ------- | ---------- | ------- | ----- |
| `__construct()` | public | Creates the module registry (`Support\Modules`). | — | void | Modules default to stored state. |
| `boot()` | public | Loads textdomain, registers services, and triggers `tcn_platform_bootstrapped`. | — | void | Invoked from `tcn_platform_boot()`. |
| `load_textdomain()` | public | Loads translations from `languages/`. | — | void | Hooked to `plugins_loaded`. |
| `register_services()` | protected | Populates `$services` with module instances depending on configuration. | — | void | Adds admin pages only in `is_admin()`. |
| `get_modules()` | public | Provides the `Support\Modules` instance. | — | `Modules` | Used by admin screens to read/write module state. |

### 3.4 Lifecycle Hooks

| Class | Method | Purpose |
| ----- | ------ | ------- |
| `TCN\Platform\Activator` | `activate()` *static* | Ensures options defaults, seeds modules, calls `MembershipModule::activate()`, fires `tcn_platform_activated`, flushes rewrite rules. |
| `TCN\Platform\Deactivator` | `deactivate()` *static* | Fires `tcn_platform_deactivated` and flushes rewrite rules. |

### 3.5 Admin UI

#### `TCN\Platform\Admin\SettingsPage`

| Method | Visibility | Purpose | Parameters | Returns | Notes |
| ------ | ---------- | ------- | ---------- | ------- | ----- |
| `__construct( Modules $modules )` | public | Store module registry for toggles. | `$modules` registry. | void | — |
| `register()` | public | Hooks menu registration and form handling. | — | void | Adds actions `admin_menu`, `admin_init`. |
| `register_menu()` | public | Adds the top-level **TCN Platform** admin menu. | — | void | Uses `add_menu_page()`. |
| `handle_form_submission()` | public | Saves module toggles, login settings, and Stripe keys. | — | void | Validates capability and nonce, fires `tcn_platform_settings_saved`. |
| `render_page()` | public | Outputs the settings screen, module cards, and membership summary table. | — | void | Requires `manage_options` capability. |
| `format_amount( $amount, string $currency )` | protected | Formats currency using WooCommerce helpers when available. | `$amount` mixed, `$currency` code. | string | Falls back to simple string format. |

#### `TCN\Platform\Admin\LogPage`

| Method | Visibility | Purpose | Parameters | Returns | Notes |
| ------ | ---------- | ------- | ---------- | ------- | ----- |
| `register()` | public | Hooks admin menu and log-clear handler. | — | void | Adds actions `admin_menu`, `admin_post_tcn_platform_clear_logs`. |
| `register_menu()` | public | Adds the **Activity Log** submenu. | — | void | — |
| `handle_clear_logs()` | public | Verifies nonce, clears logs, logs the action, redirects back with notice. | — | void | Requires `manage_options`. |
| `render_page()` | public | Renders log table with DataTables markup and notices. | — | void | Shows clear button and table. |
| `format_time( $timestamp )` | protected | Converts a Unix timestamp into the site’s date/time format. | `$timestamp` mixed. | string | Returns em dash when missing. |
| `format_source( string $source )` | protected | Normalises source labels (REST/Plugin). | `$source` | string | Defaults to `ucfirst()`. |
| `render_details( $details )` | protected | Delegates to `render_detail_fragment()` for context payloads. | `$details` mixed | string (HTML) | Output escaped/structured. |
| `render_detail_fragment( $value, int $depth = 0, string $parent_key = '' )` | protected | Recursively renders arrays/objects into definition lists, preserving booleans/numbers/badges. | Various | string (HTML) | Handles JsonSerializable, numeric arrays, badges. |
| `format_detail_label( $key )` | protected | Produces human-readable labels for context keys. | `$key` mixed | string | Maps known keys, fallback to title case. |

#### `TCN\Platform\Admin\ApiTesterPage`

| Method | Visibility | Purpose | Parameters | Returns | Notes |
| ------ | ---------- | ------- | ---------- | ------- | ----- |
| `register()` | public | Adds admin menu registration hook. | — | void | Registers submenu under TCN Platform. |
| `register_menu()` | public | Adds **API Tester** submenu entry. | — | void | — |
| `render_page()` | public | Renders the tester form, handles submissions, displays response metadata, and lists presets. | — | void | Validates capability and nonce; uses `wp_remote_request()`. |
| `prepare_url( string $endpoint )` | protected | Normalises user input into an absolute URL under the current site when relative. | `$endpoint` | string | Supports protocol-relative URLs and raw http(s). |
| `normalize_headers( $headers )` | protected | Converts response headers into a sorted key/value map for display. | `$headers` mixed | `array<string,string>` | Handles `Requests_Utility_CaseInsensitiveDictionary`. |
| `format_body_for_display( string $body )` | protected | Pretty-prints JSON bodies when possible. | `$body` | string | Fallback returns original body. |
| `get_examples()` | protected | Builds preset examples covering every REST endpoint. | — | `array<int,array<string,string>>` | Updated with authentication notes and sample payloads. |
| `abbreviate_url( string $url )` | protected | Collapses full URLs into path/query strings for card captions. | `$url` | string | Returns original when parsing fails. |

#### `TCN\Platform\Admin\Assets`

| Method | Visibility | Purpose | Parameters | Returns | Notes |
| ------ | ---------- | ------- | ---------- | ------- | ----- |
| `register()` | public | Hooks `admin_enqueue_scripts` to load plugin assets. | — | void | — |
| `enqueue_assets()` | public | Enqueues CSS/JS on TCN Platform admin screens, conditionally loads DataTables, localises strings. | — | void | Checks current screen slug before enqueuing. |

### 3.6 Authentication

#### `TCN\Platform\Auth\PasswordLoginService`

| Method | Visibility | Purpose | Parameters | Returns | Notes |
| ------ | ---------- | ------- | ---------- | ------- | ----- |
| `register()` | public | Loads login settings, registers REST routes, enforces CORS, hooks token login handler, and installs class alias. | — | void | Hooks `rest_api_init`, `rest_pre_serve_request`, `login_form_gn_token_login`. |
| `register_compatibility_alias()` | public static | Aliases class to legacy `GN_Password_Login_API`. | — | void | Called even when module disabled to preserve compatibility. |
| `register_routes()` | public | Registers `/login`, `/register`, `/forgot-password`, `/reset-password`, `/change-password`. | — | void | Called during `rest_api_init`. |
| `handle_login( WP_REST_Request $request )` | public | Authenticates credentials, enforces HTTPS, rate limits, issues token or cookies. | `$request` | array or `WP_Error` | Returns payload with `user`, `token`, etc. |
| `handle_register( WP_REST_Request $request )` | public | Creates a user, suppresses new-user emails, populates profile, fires `gn_password_api_user_registered`. | `$request` | array or `WP_Error` | Returns `user` payload. |
| `handle_forgot_password( WP_REST_Request $request )` | public | Initiates reset and optionally returns verification code. | `$request` | array | Never reveals user existence; returns success regardless. |
| `handle_reset_password( WP_REST_Request $request )` | public | Validates code or core reset key, sets new password, clears metadata, fires `gn_password_api_password_reset`. | `$request` | array or `WP_Error` | — |
| `handle_change_password( WP_REST_Request $request )` | public | Validates current password, sets new password, refreshes auth cookies, fires `gn_password_api_password_changed`. | `$request` | array or `WP_Error` | — |
| `filter_pre_serve_request( $served, $result, $request, $server )` | public | Adds CORS headers for `gn/v1` namespace. | Mixed | bool | Called during REST response serving. |
| `handle_token_login()` | public | Consumes transient token, logs user in, redirects (filterable). | — | void | Halts execution with `wp_safe_redirect()`. |
| `prepare_user_payload( WP_User $user )` | protected | Builds REST payload with membership metadata. | `$user` | array | Includes sponsor ID. |
| `get_user_from_login( string $login )` | protected | Resolves login/email to `WP_User`. | `$login` | `WP_User|null` | Returns null when not found. |
| `maybe_enforce_https( WP_REST_Request $request )` | protected | Blocks non-HTTPS requests unless dev override filter allows. | `$request` | true or `WP_Error` | Uses login settings and `gn_password_api_allow_dev_http` filter. |
| `build_rate_context( string $action, string $identifier )` | protected | Generates transient key, limit, TTL for rate limiting. | `$action`, `$identifier` | array | Combines action, username, IP. |
| `is_rate_limited( array $context )` | protected | Checks if attempts exceed limit. | `$context` | bool | — |
| `increment_rate_limit( array $context )` | protected | Increments transient counter. | `$context` | void | — |
| `reset_rate_limit( array $context )` | protected | Clears rate limit transient. | `$context` | void | — |
| `issue_login_token( int $user_id )` | protected | Generates single-use login token, stores transient. | `$user_id` | array (`token`, `expires_in`) | Filterable lifetime/token generator. |
| `build_token_key( string $token )` | protected | Computes transient key for login tokens. | `$token` | string | — |
| `get_token_transient( string $token )` | protected | Retrieves token metadata from transient. | `$token` | mixed | — |
| `validate_reset_code( int $user_id, string $code )` | protected | Checks stored hash/expiry for verification codes. | `$user_id`, `$code` | bool | Deletes meta on expiry. |
| `get_client_ip()` | protected | Extracts caller IP from server vars with sanitisation. | — | string | Used for rate limiting. |
| `issue_reset_verification_code( int $user_id, int $ttl = 900 )` | public static | Generates verification code, stores hashed meta with expiry. | `$user_id`, `$ttl` | string | Filterable code and TTL via `gn_password_api_generate_reset_code`. |

### 3.7 Membership & MLM

#### `TCN\Platform\Membership\MembershipModule`

| Method | Visibility | Purpose | Parameters | Returns | Notes |
| ------ | ---------- | ------- | ---------- | ------- | ----- |
| `__construct( $modules = null )` | public | Accepts optional container for forward compatibility; module is always enabled. | `$modules` optional | void | — |
| `activate()` | public static | Creates commission table via `dbDelta`, seeds membership products. | — | void | Called on plugin activation. |
| `register()` | public | Hooks sponsor capture, shortcodes, REST routes, WooCommerce integrations, scripts. | — | void | Adds numerous WordPress/WooCommerce actions. |
| `enqueue_public_assets()` | public | Enqueues public CSS on My Account pages or shortcode usage. | — | void | Checks `is_account_page()` and shortcode presence. |
| `register_shortcodes()` | public | Registers `[tcn_member_dashboard]`, `[tcn_genealogy]`, `[tcn_mlm_optin]`. | — | void | — |
| `register_rest_routes()` | public | Adds `tcn-mlm/v1` and membership REST routes. | — | void | Requires login for protected data. |
| `handle_api_registration( int $user_id, WP_REST_Request $request )` | public | Ensures sponsor assignment, default level, customer role, and welcome order for API signups. | `$user_id`, `$request` | void | Hooked to `gn_password_api_user_registered`. |
| `register_account_endpoints()` | public | Adds WooCommerce My Account endpoints for dashboards. | — | void | Called on `init` when WooCommerce present. |
| `register_account_query_vars( array $vars )` | public | Adds endpoint query vars. | `$vars` | array | Filter for WooCommerce query vars. |
| `register_account_menu_items( array $items )` | public | Injects MLM menu items into My Account navigation. | `$items` | array | Returns modified items. |
| `render_member_dashboard_endpoint()` | public | Echoes dashboard markup for My Account endpoint. | — | void | Calls `render_member_dashboard()`. |
| `render_genealogy_endpoint()` | public | Echoes genealogy markup for My Account endpoint. | — | void | Calls `render_genealogy()`. |
| `render_member_dashboard_shortcode()` | public | Returns dashboard markup for shortcode usage. | — | string | Delegates to `render_member_dashboard()`. |
| `render_genealogy_shortcode()` | public | Returns genealogy markup for shortcode usage. | — | string | Delegates to `render_genealogy()`. |
| `render_optin_shortcode()` | public | Outputs opt-in call-to-action. | — | string | Buffer-based HTML snippet. |
| `render_member_dashboard()` | protected | Builds member summary table, stats, and ledger for logged-in user. | — | string | Returns login prompt when unauthenticated. |
| `render_genealogy()` | protected | Generates nested genealogy tree HTML. | — | string | Renders login prompt when unauthenticated. |
| `render_genealogy_node( array $node )` | protected | Recursively renders a single node with children. | `$node` | string | Used by `render_genealogy()`. |
| `rest_get_member_profile( WP_REST_Request $request )` | public | REST callback returning profile, commissions, ledger. | `$request` | array | Requires login. |
| `rest_get_genealogy( WP_REST_Request $request )` | public | REST callback building genealogy tree with optional depth. | `$request` | array | Requires login. |
| `rest_get_commissions( WP_REST_Request $request )` | public | REST callback returning commission summary + ledger. | `$request` | array | Requires login. |
| `rest_require_login()` | public | Permission callback confirming authenticated user. | — | bool | — |
| `rest_get_membership_plans( WP_REST_Request $request )` | public | Public REST callback returning plan details, currency, Stripe key, product IDs. | `$request` | array | — |
| `rest_create_stripe_intent( WP_REST_Request $request )` | public | Creates Stripe Payment Intent or returns `requires_payment=false` for free tiers. | `$request` | array or `WP_Error` | Validates plan, Stripe keys, amount. |
| `rest_confirm_membership_upgrade( WP_REST_Request $request )` | public | Validates payment, updates membership, records commissions. | `$request` | array or `WP_Error` | Requires login. |
| `get_membership_products()` | protected | Returns map of membership slugs to WooCommerce product IDs. | — | `array<string,int>` | Queries products with `_tcn_membership_level` meta. |
| `stripe_request( string $method, string $path, array $body, string $secret )` | protected | Performs HTTP call to Stripe API. | HTTP method, endpoint path, body, secret key. | array or `WP_Error` | Normalises errors with friendly messages. |
| `handle_order_completed( int $order_id )` | public | Promotes users when completing membership orders, records commissions. | `$order_id` | void | Hooked to `woocommerce_order_status_completed`. |
| `render_product_level_field()` | public | Adds product data panel field for membership level association. | — | void | Uses `woocommerce_wp_select`. |
| `save_product_level_field( int $product_id )` | public | Persists membership level selection from product edit screen. | `$product_id` | void | Validates against defined levels. |
| `assign_sponsor_from_cookie( int $user_id )` | public | Applies sponsor cookie to new registrations, updates metrics. | `$user_id` | void | Hooked to `user_register`. |
| `ensure_customer_role( int $user_id )` | protected | Adds WooCommerce `customer` role, removes `subscriber` when redundant. | `$user_id` | void | — |
| `maybe_create_welcome_order( int $user_id, WP_REST_Request $request )` | protected | Auto-creates completed WooCommerce order for Blue tier on API signup. | `$user_id`, `$request` | void | Stores order ID in user meta. |
| `get_membership_product_id( string $level )` | protected | Resolves product ID for membership level, with slug fallback. | `$level` | int | Prefers mapping from `get_membership_products()`. |
| `get_product_id_by_slug( string $slug )` | protected | Finds product by slug. | `$slug` | int | Returns 0 when not found. |
| `ensure_sponsor_assignment( int $user_id )` | protected | Ensures user has sponsor via cookie/default setting, updates metrics. | `$user_id` | void | — |
| `record_commissions( int $member_id, int $order_id, string $level_key )` | protected | Inserts direct and passive commission rows, updates recruit counts. | Member ID, order ID, level key. | void | Writes to custom table. |
| `calculate_direct_commission_amount( string $level_key, int $sponsor_id, array $levels )` | protected | Determines direct commission amount, applying overrides by sponsor level. | `$level_key`, `$sponsor_id`, `$levels` | float | Filterable via `tcn_mlm_direct_commission_amount`. |
| `insert_commission( int $sponsor_id, int $member_id, int $order_id, string $level, float $amount, string $currency )` | protected | Inserts commission row into database. | Various | void | Uses `$wpdb->insert`. |
| `maybe_handle_ancestor_upgrades( int $user_id )` | protected | Walks sponsor chain to evaluate auto-upgrades. | `$user_id` | void | Avoids infinite loops with visited array. |
| `maybe_handle_auto_upgrade( int $user_id )` | protected | Upgrades user based on recruits/network metrics. | `$user_id` | void | Promotes Gold→Platinum, Platinum→Black, sets default Blue. |
| `set_membership_level( int $user_id, string $level )` | protected | Updates user meta for membership level and fires `tcn_mlm_user_level_changed`. | `$user_id`, `$level` | void | No change when already at level. |
| `update_direct_recruits( int $user_id )` | protected | Recalculates recruits and network metrics recursively. | `$user_id` | void | Uses `refresh_network_metrics()`. |
| `refresh_network_metrics( int $user_id, array $visited )` | protected | Updates direct recruit counts and network size for user and sponsors. | `$user_id`, `$visited` | void | Recurses up sponsor chain. |
| `count_network_members( int $user_id, array $visited = array() )` | protected | Counts descendants to populate `_tcn_network_size`. | `$user_id`, `$visited` | int | Avoids cycles. |
| `build_genealogy_tree( int $user_id, int $depth )` | protected | Builds nested array describing genealogy tree to requested depth. | `$user_id`, `$depth` | array | Used by REST and shortcode rendering. |
| `get_commission_summary( int $user_id )` | protected | Aggregates commission totals (total/paid/pending). | `$user_id` | array | Queries custom table with `$wpdb`. |
| `get_commission_ledger( int $user_id, int $limit = 25 )` | protected | Retrieves most recent commission rows. | `$user_id`, `$limit` | array | Returns associative arrays. |
| `prepare_member_payload( WP_User $user )` | protected | Formats user data for REST responses. | `$user` | array | Includes membership level, sponsor, recruits. |
| `maybe_capture_sponsor()` | public | Reads `tcn_sponsor` query parameter, sets secure cookie. | — | void | Runs on `init`; requires headers not sent. |
| `get_sponsor_cookie()` | protected | Retrieves sponsor ID from cookie. | — | int | Returns 0 when missing. |
| `format_currency( float $amount )` | protected | Formats amounts using WooCommerce `wc_price` when available. | `$amount` | string | Falls back to currency code + amount. |
| `get_level_options()` | protected | Builds select options for WooCommerce product field. | — | array | Uses `Options::get_levels()`. |
| `maybe_seed_products()` | protected static | Ensures default membership products exist with fees, metadata. | — | void | Called during activation. |

### 3.8 WooCommerce REST Bridges

#### `TCN\Platform\Rest\WooCommerceEndpoints`

| Method | Visibility | Purpose | Parameters | Returns | Notes |
| ------ | ---------- | ------- | ---------- | ------- | ----- |
| `register()` | public | Hooks REST route registration. | — | void | Adds action `rest_api_init`. |
| `register_routes()` | public | Registers `/customers` (GET/POST) and `/orders` (POST). | — | void | Defines parameter schemas and permission callbacks. |
| `permissions_check( WP_REST_Request $request )` | public | Authorises requests via current user capability or consumer keys. | `$request` | bool or `WP_Error` | Returns descriptive errors for unauthorised access. |
| `authenticate_with_consumer_keys( WP_REST_Request $request )` | protected | Validates WooCommerce consumer key/secret from headers or params. | `$request` | int user ID | Sets current user on success; updates key `last_access`. |
| `extract_consumer_credentials( WP_REST_Request $request )` | protected | Reads Basic auth header or `consumer_key`/`consumer_secret` params. | `$request` | array (`key`, `secret`) | — |
| `safe_hash_equals( string $expected, string $actual )` | protected | Performs timing-safe string comparison. | `$expected`, `$actual` | bool | Uses `hash_equals` when available. |
| `validate_email( $value )` | public | Validation callback for email args. | `$value` | bool | — |
| `sanitize_text_field_nullable( $value )` | public | Allows null values while sanitising strings. | `$value` | string|null | — |
| `validate_object_type( $value )` | public | Ensures argument is array-like (used for address payloads). | `$value` | bool | — |
| `validate_positive_int( $value )` | public | Validates positive integer arguments. | `$value` | bool | — |
| `validate_boolean_value( $value )` | public | Accepts bool/int/string truthy values for `set_paid`. | `$value` | bool | — |
| `get_customer( WP_REST_Request $request )` | public | Resolves customer by email, returning normalised data or 404 error. | `$request` | `WP_REST_Response` or `WP_Error` | Falls back to WordPress user ID. |
| `create_customer( WP_REST_Request $request )` | public | Creates WooCommerce customer, sets profile/meta, returns response with status 201. | `$request` | `WP_REST_Response` or `WP_Error` | Auto-generates password when omitted. |
| `normalize_customer_data( int $user_id )` | protected | Formats customer response structure. | `$user_id` | array | Includes billing/shipping arrays. |
| `update_customer_meta( int $user_id, string $type, array $data )` | protected | Sanitises and stores billing/shipping meta fields. | `$user_id`, `$type`, `$data` | void | Supports email sanitisation. |
| `collect_address_fields( int $user_id, string $type )` | protected | Reads stored billing/shipping fields into array. | `$user_id`, `$type` | array | — |
| `create_order( WP_REST_Request $request )` | public | Creates WooCommerce order, adds line/shipping items, totals, marks paid, returns response 201. | `$request` | `WP_REST_Response` or `WP_Error` | Deletes order and errors if payload invalid. |

### 3.9 Support Utilities

#### `TCN\Platform\Support\Options`

| Method | Visibility | Purpose | Parameters | Returns | Notes |
| ------ | ---------- | ------- | ---------- | ------- | ----- |
| `ensure_defaults()` | public static | Seeds membership levels, general settings, login settings with defaults when missing. | — | void | Used during activation. |
| `get_levels()` | public static | Retrieves membership levels merged with defaults and product pricing overlays. | — | array | Ensures only official tiers remain. |
| `update_levels( array $levels )` | public static | Persists level configuration. | `$levels` | void | — |
| `get_general_settings()` | public static | Returns general settings (currency, default sponsor, Stripe keys) with defaults applied. | — | array | — |
| `update_general_settings( array $settings )` | public static | Stores general settings. | `$settings` | void | — |
| `get_login_settings()` | public static | Retrieves login module settings with defaults. | — | array | — |
| `update_login_settings( array $settings )` | public static | Stores login settings merged with defaults. | `$settings` | void | — |
| `apply_membership_product_fees( array $levels )` | protected static | Overlays WooCommerce product pricing onto level fees. | `$levels` | array | Skips when WooCommerce unavailable. |
| `default_levels()` | public static | Provides canonical level definitions (Blue/Gold/Platinum/Black). | — | array | Used to seed options/products. |
| `default_general_settings()` | public static | Returns default currency, default sponsor, Stripe key placeholders. | — | array | — |
| `default_login_settings()` | public static | Returns default CORS, HTTPS, token, and rate limit settings. | — | array | — |

#### `TCN\Platform\Support\Modules`

| Method | Visibility | Purpose | Parameters | Returns | Notes |
| ------ | ---------- | ------- | ---------- | ------- | ----- |
| `__construct()` | public | Loads stored module state. | — | void | Modules default to stored options merged with defaults. |
| `seed_defaults()` | public static | Stores default module configuration on activation. | — | void | — |
| `get_all()` | public static | Returns merged stored/default module map. | — | array | Used internally and by other classes. |
| `defaults()` | public static | Defines baseline module state (`mlm` true, `auth_login` true). | — | array | — |
| `is_enabled( string $module )` | public | Checks if module enabled (MLM always true). | `$module` | bool | — |
| `set_enabled( string $module, bool $enabled )` | public | Sets module enabled flag, persisting changes. | `$module`, `$enabled` | void | MLM module forced true. |
| `sync( array $modules )` | public | Bulk updates modules from admin submission. | `$modules` | void | Iterates defaults to avoid stray keys. |
| `all()` | public | Returns internal module map. | — | array | Used by settings UI. |

#### `TCN\Platform\Support\ActivityMonitor`

| Method | Visibility | Purpose | Parameters | Returns | Notes |
| ------ | ---------- | ------- | ---------- | ------- | ----- |
| `__construct( array $namespaces = array( 'gn/v1', 'tcn-mlm/v1' ) )` | public | Configures REST namespaces to monitor. | `$namespaces` | void | — |
| `register()` | public | Hooks REST logging and lifecycle events. | — | void | Adds filters/actions for logging. |
| `capture_rest_activity( $response, array $handler, $request )` | public | Logs REST request metadata and scrubbed params for monitored namespaces. | Response, handler array, `WP_REST_Request`. | mixed | Returns original response; logs via `Logger::log()`. |
| `log_plugin_activated()` | public | Logs activation event with version. | — | void | Hooked to `tcn_platform_activated`. |
| `log_plugin_deactivated()` | public | Logs deactivation event with version. | — | void | Hooked to `tcn_platform_deactivated`. |
| `log_settings_saved( array $modules, array $login_settings )` | public | Logs settings changes (enabled modules, login config). | `$modules`, `$login_settings` | void | Hooked to `tcn_platform_settings_saved`. |
| `extract_namespace( string $route )` | protected | Derives namespace (e.g., `gn/v1`) from route. | `$route` | string | Used to filter monitored namespaces. |
| `resolve_status( $response )` | protected | Determines HTTP status code from response or error. | `$response` | int | Defaults to 200 or 500 for errors. |
| `resolve_user()` | protected | Returns current user login or “Guest”. | — | string | Uses `get_current_user_id()`. |
| `get_client_ip()` | protected | Extracts request IP from server vars. | — | string | Validates using `FILTER_VALIDATE_IP`. |
| `scrub_params( $params )` | protected | Recursively redacts sensitive keys (passwords, tokens) and sanitises scalars. | `$params` | array | Returns cleaned data for logging. |
| `normalize_key( string $key )` | protected | Normalises keys for logging (lowercase, restricted chars). | `$key` | string | — |

#### `TCN\Platform\Support\Logger`

| Method | Visibility | Purpose | Parameters | Returns | Notes |
| ------ | ---------- | ------- | ---------- | ------- | ----- |
| `log( string $source, string $message, array $context = array() )` | public static | Records log entry with timestamp and sanitised context. | `$source`, `$message`, `$context` | void | Keeps most recent 200 entries. |
| `get_logs()` | public static | Retrieves stored log entries. | — | array | Returns empty array when unset. |
| `clear()` | public static | Deletes log option. | — | void | Admin log clear uses this. |
| `sanitize_context( array $context )` | protected static | Normalises context keys/values before storage. | `$context` | array | Recursively sanitises. |
| `sanitize_value( $value )` | protected static | Converts scalars, arrays, objects into safe representations. | `$value` | mixed | Keeps booleans/numbers, sanitises strings. |
| `sanitize_key( string $key )` | protected static | Normalises keys for storage. | `$key` | string | Shared with `sanitize_context()`. |
| `sanitize_text( string $text )` | protected static | Sanitises text with WordPress helper. | `$text` | string | — |
| `now()` | protected static | Returns UTC timestamp for log entry. | — | int | Uses `current_time( 'timestamp', true )`. |

#### `TCN\Platform\Support\Updater`

| Method | Visibility | Purpose | Parameters | Returns | Notes |
| ------ | ---------- | ------- | ---------- | ------- | ----- |
| `register()` | public | Integrates with Plugin Update Checker library when available. | — | void | Configurable via constants/filters (`tcn_platform_update_repository_url`, `..._branch`). Enables GitHub release assets. |

---

With this reference and the expanded API tester presets, every endpoint (including WooCommerce bridges) can be exercised in seconds from within WordPress. Combine the method tables with your IDE or code reviews to trace hooks, REST callbacks, and WooCommerce touch points without hunting through the source.
